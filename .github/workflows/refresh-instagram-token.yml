name: Refresh Instagram Token

on:
  schedule:
    - cron: "0 5 1 * *"
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Refresh long-lived token
        id: refresh
        env:
          INSTAGRAM_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
        run: |
          set -euo pipefail

          if [ -z "${INSTAGRAM_ACCESS_TOKEN:-}" ]; then
            echo "Missing INSTAGRAM_ACCESS_TOKEN secret" >&2
            exit 1
          fi

          RESPONSE=$(curl -sS -G "https://graph.instagram.com/refresh_access_token" \
            --data-urlencode "grant_type=ig_refresh_token" \
            --data-urlencode "access_token=${INSTAGRAM_ACCESS_TOKEN}")

          NEW_TOKEN=$(echo "$RESPONSE" | jq -r '.access_token // empty')
          EXPIRES_IN=$(echo "$RESPONSE" | jq -r '.expires_in // empty')

          if [ -z "$NEW_TOKEN" ]; then
            echo "Refresh failed: $RESPONSE" >&2
            exit 1
          fi

          {
            echo "new_token=$NEW_TOKEN"
            echo "expires_in=$EXPIRES_IN"
          } >> "$GITHUB_OUTPUT"

      - name: Update Supabase secret
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          PROJECT_REF: ${{ vars.SUPABASE_PROJECT_REF }}
          NEW_TOKEN: ${{ steps.refresh.outputs.new_token }}
        run: |
          set -euo pipefail

          if [ -z "${SUPABASE_ACCESS_TOKEN:-}" ]; then
            echo "Missing SUPABASE_ACCESS_TOKEN secret" >&2
            exit 1
          fi

          if [ -z "${PROJECT_REF:-}" ]; then
            echo "Missing SUPABASE_PROJECT_REF repository variable" >&2
            exit 1
          fi

          npx supabase secrets set INSTAGRAM_ACCESS_TOKEN="$NEW_TOKEN" --project-ref "$PROJECT_REF"

      - name: Summary
        env:
          EXPIRES_IN: ${{ steps.refresh.outputs.expires_in }}
        run: |
          echo "Instagram token refreshed. expires_in=${EXPIRES_IN}s" >> "$GITHUB_STEP_SUMMARY"
